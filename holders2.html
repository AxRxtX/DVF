<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holders Live Data</title>

    <style>
        body {
            background-color: #121212; /* Almost black */
            color: white; /* Font color */
            font-family: Verdana, sans-serif;
            font-size: 10px;
            text-align: center; /* Center elements */
        }

        h1 {
            font-size: 32px; /* Twice as big */
            font-weight: bold;
            margin-bottom: 24px;
            color: #D32F2F; /* Font color */
        }

        .table-container {
            display: flex;
            justify-content: center;
        }

        table {
            border-collapse: collapse;
            width: 60%; /* Reduce table width */
            border: 2px solid #8B0000; /* Outer border */
        }

        th, td {
            border: 1px solid #8B0000 !important; /* Thin border */
            padding: 8px;
            text-align: center;
            font-size: 14px; /* Row font size */
        }

        th {
            background-color: #333; /* Dark gray for headers */
            font-size: 18px; /* Header font size */
            font-weight: bold;
        }

        /* Align first two columns to the right */
        td:nth-child(1), td:nth-child(2) {
            text-align: left;
        }

        /* Center-align the rest */
        td:nth-child(3), td:nth-child(4), td:nth-child(5) {
            text-align: center;
        }
        
        td {
            width: 100px; /* Set column width */
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden;
            text-overflow: ellipsis; /* Add "..." for long text */
        }
    </style>
   
</head>



<body>
    <div class="container">
        <h1>Holders Live Data</h1>

        <!-- Table 1: Holders -->
        <table id="holdersTable">
            <thead>
                <tr>
                    <th>Discord Name</th>
                    <th>ClubGG Name</th>
                    <th>NFT Balance</th>
                    <th>NFT Eligible</th>
                    <th>EOM Points</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>Last Transactions (Filtered)</h2>

        <!-- Table 2: Filtered Transactions -->
        <table id="lastTxTable">
            <thead>
                <tr>
                    <th>NFT ID</th>
                    <th>Age (Days)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
      const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw-zIpOz_-jMVB8I8xjdVfkubC8X2BjGVXMwheuk4PeLPbgVkJOWo3aP_M8QEGGmbEX/exec"; // Replace with your actual WebApp URL

        async function fetchData() {
            const response = await fetch(WEB_APP_URL);
            const data = await response.json();
            return data;
        }

        async function loadTables() {
            const data = await fetchData();
            const holdersData = data.holders;
            const lastTxData = data.lastTx;

            // Display Holders Table (Table 1)
            const holdersTable = document.getElementById("holdersTable").querySelector("tbody");
            holdersTable.innerHTML = "";

            holdersData.sort((a, b) => {
                if (b[4] !== a[4]) return b[4] - a[4]; // Sort by Balance (Descending)
                return a[2].localeCompare(b[2]); // Then by ClubGG Name (Ascending)
            });

            holdersData.forEach((row, rowIndex) => {
                if (row[4] > 0 && row[1].trim() !== "") { // Balance > 0 AND Discord name not empty
                    let tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${row[1]}</td> <!-- Discord Name -->
                        <td>${row[2]}</td> <!-- ClubGG Name -->
                        <td>${row[4]}</td> <!-- NFT Balance -->
                        <td>${row[6]}</td> <!-- NFT Eligible -->
                        <td>${row[7]}</td> <!-- EOM Points -->
                    `;

                    tr.dataset.holderKey = row[3]; // Store Column [4] as a data attribute
                    holdersTable.appendChild(tr);
                   
                }
            });

    console.log("Table 1 Loaded, Adding Click Listeners...");

    // Attach click event to all rows AFTER they are created
    document.querySelectorAll("#holdersTable tbody tr").forEach(row => {
        row.addEventListener("click", function () {
            let holderKey = this.dataset.holderKey; // Retrieve stored key
            console.log(`üñ± Clicked Row v4, Key: ${holderKey}`);
            showLastTx(holderKey, lastTxData);
        });
    });

    console.log("Click Events Attached");


            
        }

function showLastTx(holderKey, lastTxData) {
    console.log("üîé Filtering Transactions for:", holderKey);

    // Debug: Log LastTX first to verify data
    console.log("üìã LastTX Data:", lastTxData);

    // Ensure filtering works by converting both to strings
    const filteredTxs = lastTxData.filter(tx => String(tx[2]) === String(holderKey) && tx[6] === "");

    console.log("‚úÖ Filtered Transactions:", filteredTxs);

    const lastTxTable = document.getElementById("lastTxTable").querySelector("tbody");
    lastTxTable.innerHTML = "";

    if (filteredTxs.length === 0) {
        console.log("‚ö†Ô∏è No matching transactions found.");
        lastTxTable.innerHTML = "<tr><td colspan='2'>No transactions found.</td></tr>";
        return;
    }

    filteredTxs.forEach(tx => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${tx[0]}</td> <!-- NFT ID -->
            <td>${tx[5]}</td> <!-- Age (Days) -->
        `;
        lastTxTable.appendChild(tr);
    });

    console.log("‚úÖ Table 2 Updated");
}



        loadTables();
    </script>
</body>

  

  
</html>
