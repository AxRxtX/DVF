<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holders Live Data</title>

    <style>

    body {
        background-color: #121212; /* Almost black */
        color: white; /* Font color */
        font-family: Verdana, sans-serif;
        font-size: 10px;
        text-align: center; /* Center elements */
        margin: 0; /* Remove default margins */
        padding: 0; /* Remove default padding */
    }
    
    h1 {
        font-size: 32px; /* Twice as big */
        font-weight: bold;
        margin-bottom: 24px;
        color: #D32F2F; /* Font color */
    }
    
    .table-container {
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Align tables at the top */
        flex-direction: column;
        gap: 20px; /* Space between tables */
        padding: 20px; /* Add padding around the tables */
    }
    
    table {
        border-collapse: collapse;
        width: 80%; /* Adjust width as necessary */
        border: 2px solid #8B0000; /* Outer border */
        margin: 0 auto; /* Center the tables horizontally */
    }
    
    th, td {
        border: 1px solid #8B0000 !important; /* Thin border */
        padding: 8px;
        text-align: center;
        font-size: 14px; /* Row font size */
    }
    
    th {
        background-color: #333; /* Dark gray for headers */
        font-size: 18px; /* Header font size */
        font-weight: bold;
    }
    
    /* Align first two columns to the left */
    td:nth-child(1), td:nth-child(2) {
        text-align: left;
    }
    
    /* Center-align the rest */
    td:nth-child(3), td:nth-child(4), td:nth-child(5) {
        text-align: center;
    }
    
    td {
        width: 100px; /* Set column width */
        white-space: nowrap; /* Prevent text wrapping */
        overflow: hidden;
        text-overflow: ellipsis; /* Add "..." for long text */
    }

    #holdersTable {
        width: 60%; /* Table 1 - 60% width */
        border: 2px solid #8B0000; /* Outer border */
        margin: 0 auto; /* Center the table horizontally */
        }
        
#lastTxTable {
    display: none; /* Initially hidden */
    width: 40%; /* Table 2 width */
    margin: 20px auto; /* Add margin for spacing and center the table */
    border: 2px solid #8B0000; /* Optional: Adjust border styling */
    border-collapse: collapse; /* Ensure borders collapse properly */
}

#lastTxTable th, #lastTxTable td {
    padding: 8px;
    text-align: center; /* Center text in both header and cells */
    border: 1px solid #8B0000; /* Border for cells */
}

#lastTxTable td {
    white-space: nowrap; /* Prevent text from wrapping */
    overflow: hidden; /* Hide overflow text */
    text-overflow: ellipsis; /* Add ellipsis for overflow text */
}

        
    </style>
   
</head>



<body>
    <div class="container">
        <h1>Holders Live Data</h1>

        <!-- Table 1: Holders -->
        <table id="holdersTable">
            <thead>
                <tr>
                    <th>Discord Name</th>
                    <th>ClubGG Name</th>
                    <th>NFT Balance</th>
                    <th>NFT Eligible</th>
                    <th>EOM Points</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- Table 2: Filtered Transactions -->
        <table id="lastTxTable">
            <thead>
                <tr>
                    <th>NFT ID</th>
                    <th>Age (Days)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
      const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw-zIpOz_-jMVB8I8xjdVfkubC8X2BjGVXMwheuk4PeLPbgVkJOWo3aP_M8QEGGmbEX/exec"; // Replace with your actual WebApp URL

        async function fetchData() {
            const response = await fetch(WEB_APP_URL);
            const data = await response.json();
            return data;
        }

        async function loadTables() {
            const data = await fetchData();
            const holdersData = data.holders;
            const lastTxData = data.lastTx;

            // Display Holders Table (Table 1)
            const holdersTable = document.getElementById("holdersTable").querySelector("tbody");
            holdersTable.innerHTML = "";

            holdersData.sort((a, b) => {
                if (b[4] !== a[4]) return b[4] - a[4]; // Sort by Balance (Descending)
                return a[2].localeCompare(b[2]); // Then by ClubGG Name (Ascending)
            });

            holdersData.forEach((row, rowIndex) => {
                if (row[4] > 0 && row[1].trim() !== "") { // Balance > 0 AND Discord name not empty
                    let tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${row[1]}</td> <!-- Discord Name -->
                        <td>${row[2]}</td> <!-- ClubGG Name -->
                        <td>${row[4]}</td> <!-- NFT Balance -->
                        <td>${row[6]}</td> <!-- NFT Eligible -->
                        <td>${row[7]}</td> <!-- EOM Points -->
                    `;

                    tr.dataset.holderKey = row[3]; // Store Column [4] as a data attribute
                    holdersTable.appendChild(tr);
                   
                }
            });

    console.log("Table 1 Loaded, Adding Click Listeners...");

    // Attach click event to all rows AFTER they are created
    document.querySelectorAll("#holdersTable tbody tr").forEach(row => {
        row.addEventListener("click", function () {
            let holderKey = this.dataset.holderKey; // Retrieve stored key
            console.log(`üñ± Clicked Row v5, Key: ${holderKey}`);
            showLastTx(holderKey, lastTxData);
        });
    });

    console.log("Click Events Attached");
            
    }


    function showLastTx(holderKey, lastTxData) {
        console.log("üîé Filtering Transactions for:", holderKey);
    
        // Debug: Log LastTX first to verify data
        console.log("üìã LastTX Data:", lastTxData);
    
        let filteredTxs = lastTxData.filter(tx => String(tx[2]) === String(holderKey));
        filteredTxs = filteredTxs.sort((a, b) => b[5] - a[5]);

        
        console.log("‚úÖ Filtered Transactions:", filteredTxs);
    
        const container = document.querySelector('.container'); // Get the main container
        const holdersTable = document.getElementById("holdersTable");
    
        // Clear any existing tables in the container (including Table 1)
        container.innerHTML = "";
    
        // Add the title for Table 2
        const title = document.createElement("h1");
        title.textContent = "NFT Eligibility";
        container.appendChild(title); // Append the title to the container
    
        // Create a new Table 2 (filtered transactions)
        const lastTxTable = document.createElement("table");
        lastTxTable.id = "lastTxTable";

        
        lastTxTable.style.display = "table"; // Ensure Table 2 is visible
        lastTxTable.innerHTML = `
            <thead>
                <tr>
                    <th>NFT ID</th>
                    <th>Age (Days)</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
    
        const lastTxTableBody = lastTxTable.querySelector("tbody");
        
       
        // Populate Table 2 with filtered transactions
        if (filteredTxs.length === 0) {
            console.log("‚ö†Ô∏è No matching transactions found.");
            lastTxTableBody.innerHTML = "<tr><td colspan='2'>No transactions found.</td></tr>";
        } else {
            filteredTxs.forEach(tx => {
                let age = parseFloat(tx[5]).toFixed(2); // Column 6 (Age) rounded to 2 decimals
                let hasValueInColumn7 = tx[6] !== ""; // Column 7 is NOT empty
    
                let status = hasValueInColumn7 
                    ? (age < 30 ? age : "Listed on OS") 
                    : age; // If Column 7 is empty, just display Age normally
    
                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${tx[0]}</td> <!-- NFT ID -->
                    <td>${status}</td> <!-- Age or "Listed on OS" -->
                `;
                lastTxTableBody.appendChild(tr);
            });
        }
    
        // Append the new Table 2 to the container
        container.appendChild(lastTxTable);
    
        console.log("‚úÖ Table 2 Updated");
    }


  

        



        loadTables();
    </script>
</body>

  

  
</html>
